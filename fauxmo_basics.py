''' 
|  @file fauxmo_basics.py
|  @brief Basic Functions for Fauxmo Handlers
|  
'''

import time, socket, logging, sys, os

commands = {'tv_toggle':"sendir,1:1,1,38580,1,1,10,70,10,30,10,30,10,30,10,30,10,30,10,70,10,70,10,30,10,70,10,30,10,30,10,30,10,70,10,30,10,1765,10,70,10,30,10,30,10,30,10,30,10,70,10,30,10,30,10,70,10,30,10,70,10,70,10,70,10,30,10,70,10,1685,10,70,10,30,10,30,10,30,10,30,10,30,10,70,10,70,10,30,10,70,10,30,10,30,10,30,10,70,10,30,10,3800",
			   'stero_toggle':"sendir,1:3,7,40064,1,1,96,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,908,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,908,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,908,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,908,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,908,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,4000",
			   'blueray_toggle':"sendir,1:3,1,40192,1,1,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,529,96,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,528,96,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,553,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,554,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,554,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,554,97,23,49,23,25,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,49,23,49,23,49,4000",
			   'dvr_toggle':"sendir,1:3,1,37764,1,1,340,170,19,85,19,170,19,85,19,170,19,85,19,85,19,85,19,85,19,85,19,85,19,85,19,85,19,85,19,170,19,170,19,85,19,1239,340,85,19,3331,340,85,19,3331,340,85,19,3700",
			   'stereo_input_sat':"sendir,1:3,1,40192,1,1,97,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,898,96,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,888,96,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,921,97,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,921,97,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,921,97,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,921,97,23,49,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,49,4000",
			   'stereo_input_tv':"sendir,1:3,1,40192,1,1,97,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,874,96,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,864,96,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,897,97,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,897,97,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,897,97,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,897,97,23,25,23,49,23,25,23,49,23,25,23,49,23,49,23,25,23,25,23,25,23,25,23,49,23,49,23,25,23,25,4000",
			   'stereo_input_bd':"sendir,1:3,5,40192,1,1,97,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,628,96,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,623,96,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,660,97,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,660,97,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,660,97,23,25,23,49,23,49,23,25,23,49,23,25,23,25,23,25,23,25,23,25,23,25,23,49,23,25,23,25,23,25,23,49,23,25,23,49,23,25,23,25,4000"}			   


def send_command(ip, command):
	sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	sock.connect((device_ips[device], device_ports[device]))
	sock.settimeout(2)
	logging.debug("Sending command: " + command + " to " + device)
	sock.sendall(commands[command]+"\r")
	msg = sock.recv(4096)
	logging.debug("Recevied message: " + msg + " from " + device)
	sock.close()
	del sock
	return True

def ping(ip):
	results = os.system("ping -c1 -W2 -q " + ip)
	return (results == 0)

class debounce_handler(object):
    """Use this handler to keep multiple Amazon Echo devices from reacting to
       the same voice command.
    """
    DEBOUNCE_SECONDS = 0.3

    def __init__(self):
        self.lastEcho = time.time()

    def on(self, client_address, name):
        if self.debounce():
            return True
        return self.act(client_address, True, name)

    def off(self, client_address, name):
        if self.debounce():
            return True
        return self.act(client_address, False, name)

    def act(self, client_address, state):
        pass

    def debounce(self):
        if (time.time() - self.lastEcho) < self.DEBOUNCE_SECONDS:
            return True

        self.lastEcho = time.time()
        return False